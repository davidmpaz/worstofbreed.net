---
import { getCollection } from "astro:content";
import "../../../styles/global.css";
import "@fontsource/space-mono/400.css";
import "@fontsource/space-mono/400-italic.css";
import "@fontsource/space-mono/700.css";

export async function getStaticPaths() {
    const cards = await getCollection("patterns");
    return cards.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const {
    title,
    category,
    stats,
    quote,
    specialAbility,
    imagePlaceholder,
    dateAdded,
    tags,
} = entry.data;
const { Content } = await entry.render();

const formattedDate = dateAdded.toISOString().split("T")[0];
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Social Share - {title}</title>
        <script>
            import { snapdom } from "@zumer/snapdom";

            document.addEventListener("DOMContentLoaded", () => {
                const downloadFrontBtn =
                    document.getElementById("download-front");
                const downloadBackBtn =
                    document.getElementById("download-back");
                const frontNode = document.getElementById("social-front");
                const backNode = document.getElementById("social-back");
                const controls = document.querySelector(".controls");
                const slug = controls?.getAttribute("data-slug") || "pattern";

                downloadFrontBtn?.addEventListener("click", async () => {
                    if (frontNode) {
                        try {
                            const blob = await snapdom.toBlob(frontNode, {
                                width: 1080,
                                height: 1350,
                                scale: 1, // Exact dimensions
                                type: "png",
                            });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = `${slug}-front.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            console.error("Snapdom failed:", e);
                            alert("Failed to generate image. Check console.");
                        }
                    }
                });

                downloadBackBtn?.addEventListener("click", async () => {
                    if (backNode) {
                        try {
                            const blob = await snapdom.toBlob(backNode, {
                                width: 1080,
                                height: 1350,
                                scale: 1,
                                type: "png",
                            });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = `${slug}-back.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            console.error("Snapdom failed:", e);
                            alert("Failed to generate image. Check console.");
                        }
                    }
                });
            });
        </script>
    </head>
    <body>
        <div class="controls" data-slug={entry.slug}>
            <h1>Social Assets for: {title}</h1>
            <div class="button-group">
                <button id="download-front">Download Front</button>
                <button id="download-back">Download Back</button>
            </div>
            <a href={`/patterns/${entry.slug}`}>&larr; Back to Pattern</a>
        </div>

        <div class="preview-area">
            <!-- FRONT CARD -->
            <div id="social-front" class="social-card front">
                <header class="card-header">
                    <span class="title">{title}</span>
                    <span class="badge">{category}</span>
                </header>

                <div class="card-visual">
                    <span class="visual-icon">{imagePlaceholder || "⚠️"}</span>
                    <div class="scanlines"></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="label">Latency</span>
                        <span class="value">{stats.latency}/100</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">Pain</span>
                        <span class="value text-alert">{stats.pain}/100</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">Maintain</span>
                        <span class="value">{stats.maintainability}/100</span>
                    </div>
                    <div class="stat-box">
                        <span class="label">Resume</span>
                        <span class="value">{stats.resumeValue}</span>
                    </div>
                </div>

                <div class="card-body">
                    <blockquote class="quote">&gt; "{quote}"</blockquote>
                    <div class="ability">
                        <span class="ability-title"
                            >★ {specialAbility.name}</span
                        >
                        <p class="ability-desc">{specialAbility.description}</p>
                    </div>
                </div>

                <footer class="card-footer">
                    <span>worstofbreed.net</span>
                </footer>
            </div>

            <!-- BACK CARD -->
            <div id="social-back" class="social-card back">
                <header class="card-header invert">
                    <span>// ANALYSIS_LOG</span>
                    <span class="slug-ref">{entry.slug}</span>
                </header>
                <div class="meta-tags invert">
                    <span>DATE: {formattedDate}</span>
                    <span>TAGS: {tags.join(", ")}</span>
                </div>
                <div class="markdown-content">
                    <Content />
                </div>
                <footer class="card-footer invert">
                    <span>worstofbreed.net</span>
                </footer>
            </div>
        </div>
    </body>
</html>

<style>
    /* Reset & Base */
    body {
        background: #333;
        color: #fff;
        font-family: var(--font-primary);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
    }

    .controls {
        background: #222;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        width: 100%;
        max-width: 800px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .controls h1 {
        margin-top: 0;
        font-size: 1.5rem;
    }

    .button-group {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
    }

    button {
        background: var(--accent);
        color: var(--ink);
        border: none;
        padding: 10px 20px;
        font-weight: bold;
        cursor: pointer;
        font-family: var(--font-mono);
        text-transform: uppercase;
        font-size: 1rem;
    }

    button:hover {
        background: #fff;
    }

    a {
        color: #aaa;
        text-decoration: none;
    }
    a:hover {
        color: #fff;
        text-decoration: underline;
    }

    .preview-area {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
        /* Scale down the preview so it fits on screen nicely, user will dl full size */
        transform: scale(0.6);
        transform-origin: top center;
        /* Compensate for scale to avoid huge empty space if needed, 
           but simple flex wrap is fine for admin tool */
    }

    /* THE CARD STYLES - FIXED DIMENSIONS 1080x1350 */
    .social-card {
        width: 1080px;
        height: 1350px;
        background: var(--paper);
        color: var(--ink); /* Explicitly set text color for card */
        border: 12px solid var(--ink); /* Thicker border for high res */
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        /* Ensure font sizes look right at this resolution */
        font-size: 2rem;
        flex-shrink: 0;
    }

    /* FRONT SPECIFIC */
    .front {
        /* Layout logic similar to Card but utilizing vertical space */
    }

    .card-header {
        background: var(--ink);
        color: var(--paper);
        padding: 30px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        text-transform: uppercase;
        font-size: 2.2rem;
        flex-shrink: 0;
    }

    .title {
        font-size: 2rem;
    }
    .badge {
        background: var(--accent);
        color: var(--ink);
        padding: 5px 15px;
        font-size: 1.8rem;
    }

    .card-visual {
        flex: 1 10 350px; /* Grow 1, Shrink strongly (10), Basis 350px */
        min-height: 200px; /* Decent minimal size */
        border-bottom: 12px solid var(--ink);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10rem; /* Slightly smaller icon */
        position: relative;
        background: #eee;
        /* flex-shrink handled by flex shorthand above */
    }

    .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
            linear-gradient(
                90deg,
                rgba(255, 0, 0, 0.06),
                rgba(0, 255, 0, 0.02),
                rgba(0, 0, 255, 0.06)
            );
        background-size:
            100% 6px,
            6px 100%; /* Scaled up scanlines */
        pointer-events: none;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        border-bottom: 12px solid var(--ink);
        flex-shrink: 0;
    }

    .stat-box {
        padding: 10px 20px;
        border-right: 6px solid var(--ink);
        border-bottom: 6px solid var(--ink);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .stat-box:nth-child(even) {
        border-right: none;
    }
    .stat-box:nth-last-child(-n + 2) {
        border-bottom: none;
    }

    .stat-box .label {
        font-size: 1.2rem;
        text-transform: uppercase;
        opacity: 0.6;
    }
    .stat-box .value {
        font-size: 2.2rem;
        font-weight: bold;
    }
    .text-alert {
        color: red;
    }

    .card-body {
        padding: 40px;
        flex: 1 1 auto; /* Grow 1, Shrink 1, Basis Auto (content size) */
        display: flex;
        flex-direction: column;
        justify-content: center; /* Center content vertically if space allows */
        gap: 30px;
        overflow: hidden; /* Prevent spillover */
    }

    .quote {
        border-left: 10px solid var(--accent);
        padding-left: 30px;
        font-style: italic;
        margin: 0;
        font-size: 2.2rem; /* Slightly smaller */
        line-height: 1.4;
    }

    .ability {
        background: #f0f0f0;
        border: 6px solid var(--ink);
        padding: 30px;
        font-size: 2rem;
    }

    .ability-title {
        font-weight: bold;
        display: block;
        text-transform: uppercase;
        margin-bottom: 15px;
        color: var(--accent);
        background: var(--ink);
        display: inline-block;
        padding: 5px 10px;
    }

    .card-footer {
        padding: 20px 30px;
        font-size: 1.5rem;
        text-align: right;
        border-top: 12px solid var(--ink);
        background: #eee;
        font-weight: bold;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    /* BACK SPECIFIC */
    .back {
        background: var(--ink);
        color: var(--paper);
    }

    .invert {
        background: var(--paper);
        color: var(--ink);
    }
    .back .card-header.invert {
        background: var(--paper);
        color: var(--ink);
    }
    .back .card-footer.invert {
        background: var(--paper);
        color: var(--ink);
    }

    .slug-ref {
        font-size: 1.5rem;
        opacity: 0.7;
    }

    .meta-tags {
        padding: 0px 20px 20px;
        font-size: 1.6rem;
        border-bottom: 6px solid var(--ink);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .markdown-content {
        padding: 20px 40px;
        font-size: 2.1rem; /* Highly readable font size */
        line-height: 1.6;
        flex-grow: 1;
        overflow: hidden; /* No scrollbars on image, content must fit or be ok cut off (but we aim to fit) */
    }

    /* Markdown Text Styles Scaled Up */
    .markdown-content :global(h2) {
        font-size: 2.8rem;
        text-decoration: underline;
        margin-top: 0;
        margin-bottom: 0.8em;
        color: var(--accent);
    }
    .markdown-content :global(h3) {
        font-size: 2.4rem;
        margin-bottom: 0.6em;
        color: var(--paper);
        border-bottom: 2px solid var(--accent);
    }

    .markdown-content :global(p) {
        margin-bottom: 1.2em;
    }
    .markdown-content :global(strong) {
        color: var(--accent);
    }
    .markdown-content :global(ul) {
        padding-left: 1.5em;
        margin-bottom: 1.2em;
    }
    .markdown-content :global(li) {
        margin-bottom: 0.5em;
    }
</style>
